#include <stdio.h>
#include <iostream>
#include "VDDCRec/kdcvd.h"
#include "VDDCRec/ktracks.h"
#include "KrdEdxPId/KrdEdxPId.hh"
#include "KDisplay/kdisplay_event.h"
#include "KrMu/mu_system.h"
#include "KrMu/mu_event.h"
#include "KrMu/mu_status.h"
#include <TApplication.h>
#include "TH1.h"
#include "TCanvas.h"

using namespace std; 
int main() {
  // default parameters
  int run=21723,Nevents=100,cosmic=0;
  // for command string arguments
  int iarg;
  // for event reading in and reconstructuion
  char fname[80];
  int openerr,runerr,readerr,closeerr,recselect=0;
  // for access to tracks  

  TApplication* theApp=new TApplication("App", NULL, NULL);
  TCanvas* cP1=new TCanvas("TEST Ampl graph1","A Graph",900,700);
  TH1F* p_mu=new TH1F("HistMuProb","Prob",150,-0.1,1.1);

  dcdedxpidinit(&run);
  bool msk[6];
  for(int i=0;i<6;i++) msk[i]=true;
  //msk[3]=false;
  msk[2]=false;
  msk[0]=false;
  pidinitpar(0.00001,msk);
  //kDClayerOff(7,0);
  // kDClayerOff(6,0);
  // kDClayerOff(1,3);
  // general initialization
 if(mu_default_init(1))  cout<<"Mu init error"<<endl;
   if(mu_init_status())  cout<<"Mu init status error"<<endl;
   // kdcvdnocosmic();
kdcvdcosmic();

 sprintf(fname,"/space/runs/daq%06d.nat",run);
 // sprintf(fname,"/store/users/offline/Skim/Cosm/cos%06d.nat",run);
 
  kedr_open_nat(fname,&openerr);
  if( openerr) {
    printf("open error for %s\n",fname);
    exit(1);
  }
  if(mu_get_db_status(run))  cout<<"Mu status error"<<endl;
  if(mu_get_db_clbr_for_run(run)<0)  cout<<"Mu calib error"<<endl;
  while(1) 
  {
    // read event
    kedr_read_nat(&readerr);
    if(readerr) break;
    // event reconstruction
    kdcvdrec(0,&recselect);
    cout<<"************************** "<<eNumber<<endl;
    pidevent();
    kdisplay_event();
    for(int t=0; t<eTracksAll; t++) {
      // if(tP(t)<800.){
	unsigned short MuNhitsRaw = mu_next_event_good();
	//	cout<<"MuNhitsRaw  "<<MuNhitsRaw <<endl;
      if(dcinfo.st[t]==1&&tP(t)>100.&&MuNhitsRaw!=0){
	cout<<"Ptr "<<tPt(t)<<" dedx "<<dcinfo.dedx[t]<<" rms "<<dcinfo.rms[t]<<" hypo "<<dcinfo.bhypo[t]<<endl;
	if(dcinfo.p[t][1]>0.0) p_mu->Fill(dcinfo.p[t][1]);
	//	kdisplay_event();
	  }
    }
    if(eNumber > Nevents) 
      {
	cout<<"break \n";
	break;
      }
  }
   kedr_close_nat(&closeerr);
   p_mu->Draw();
   cP1->SetFillColor(0);
   cP1->Update();
   theApp->Run();
   theApp->Terminate();  
}
